import{A as H,B as J,D as K,E as Q,F as U,I as W,J as X,P as Y,Q as Z,R as ee,S as te,T as ie,U as ae,W as oe,ma as ne,wa as p,za as me}from"./chunk-YJA7LBCE.js";import{$a as I,Cb as E,Ea as c,Fa as t,Ga as i,Ha as u,Kb as _,Lb as P,Oa as F,P as g,Q as S,Qa as D,Ra as C,Tb as x,_b as w,ac as s,db as a,dc as N,ea as l,eb as v,ec as V,ia as h,ic as q,jc as A,lc as R,ma as y,md as B,oc as k,qa as b,qc as T,rc as O,rd as z,tc as $,td as L,uc as G,vc as j,vd as re}from"./chunk-JUX2TMYD.js";function he(d,e){if(d&1&&(t(0,"mat-option",31),a(1),i()),d&2){let r=e.$implicit;c("value",r.value),l(),v(r.label)}}function ve(d,e){if(d&1&&(t(0,"mat-option",31),a(1),i()),d&2){let r=e.$implicit;c("value",r),l(),v(r)}}function ge(d,e){d&1&&u(0,"mat-spinner",32)}function Se(d,e){if(d&1&&(t(0,"span"),a(1),i()),d&2){let r=C();l(),v(r.mode==="edit"?"Actualizar":"Crear")}}var se=class d{constructor(e,r,o,n,m){this.fb=e;this.dialogRef=r;this.data=o;this.cdr=n;this.appStateService=m;this.mode=o.mode,this.prestamoForm=this.createForm()}prestamoForm;loading=!1;mode;_isFormInvalid=!0;tiposPrestamo=[{value:"personal",label:"Personal"},{value:"hipotecario",label:"Hipotecario"},{value:"automotriz",label:"Automotriz"},{value:"empresarial",label:"Empresarial"}];estados=[{value:"activo",label:"Activo"},{value:"pagado",label:"Pagado"},{value:"vencido",label:"Vencido"},{value:"cancelado",label:"Cancelado"}];diasVencimiento=Array.from({length:28},(e,r)=>r+1);ngOnInit(){this.data.prestamo&&(this.mode==="edit"||this.mode==="duplicate")&&this.loadPrestamoData(this.data.prestamo),this.prestamoForm.valueChanges.subscribe(()=>{this.calculateCuotaMensual()})}ngAfterViewInit(){setTimeout(()=>{this.updateFormState()})}createForm(){return this.fb.group({descripcion:["",[s.required,s.minLength(3)]],entidad:["",s.required],tipo:["personal",s.required],monto:[0,[s.required,s.min(.01)]],tasaInteres:[0,[s.required,s.min(0)]],cuotas:[12,[s.required,s.min(1),s.max(360)]],fechaInicio:[new Date,s.required],diaVencimiento:[new Date().getDate(),s.required],estado:["activo",s.required]})}loadPrestamoData(e){this.prestamoForm.patchValue({descripcion:e.descripcion,entidad:e.entidad,tipo:e.tipo,monto:e.monto,tasaInteres:e.tasaInteres,cuotas:e.cuotas??e.duracionMeses,fechaInicio:this.toMonthDate(e.fechaInicio),diaVencimiento:e.diaVencimiento,estado:e.estado})}get cuotaMensual(){let e=this.prestamoForm.get("monto")?.value||0,r=this.prestamoForm.get("tasaInteres")?.value||0,o=this.prestamoForm.get("cuotas")?.value||1;if(e<=0||o<=0)return 0;if(r===0)return e/o;let n=r/100/12,m=Math.pow(1+n,o);return e*n*m/(m-1)}get totalAPagar(){let e=this.prestamoForm.get("cuotas")?.value||0;return this.cuotaMensual*e}get interesesTotales(){let e=this.prestamoForm.get("monto")?.value||0;return this.totalAPagar-e}calculateCuotaMensual(){}toMonthString(e){if(e instanceof Date)return p(e,"yyyy-MM");if(typeof e=="string"){let r=e.trim(),o=r.match(/^(\d{4})-(\d{2})$/);if(o)return`${o[1]}-${o[2]}`;let n=r.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(n)return`${n[1]}-${n[2]}`;let m=new Date(r);if(!isNaN(m.getTime()))return p(m,"yyyy-MM")}return typeof e=="number"&&Number.isFinite(e)?p(new Date(e),"yyyy-MM"):p(new Date,"yyyy-MM")}toMonthDate(e){let r=this.toMonthString(e),[o,n]=r.split("-"),m=Number(o),f=Number(n);return!Number.isFinite(m)||!Number.isFinite(f)?new Date:new Date(m,f-1,1)}get isFormInvalid(){return this._isFormInvalid}get isFormPristine(){return this.prestamoForm?.pristine||!0}updateFormState(){this.prestamoForm&&(this._isFormInvalid=this.prestamoForm.invalid,this.cdr.detectChanges(),this.prestamoForm.statusChanges.subscribe(()=>{this._isFormInvalid=this.prestamoForm.invalid,this.cdr.detectChanges()}))}onSubmit(){this.onSave()}onReset(){this.resetForm()}resetForm(){this.prestamoForm.reset({tipo:"personal",fechaInicio:new Date,diaVencimiento:new Date().getDate(),estado:"activo",cuotas:12})}onSave(){if(this.prestamoForm.valid){this.loading=!0;let e=this.prestamoForm.value,r=Number(e.monto)||0,o=Number(e.tasaInteres)||0,n=Number(e.cuotas)||0,m=this.data.prestamo?.cuotasRestantes,f=m!==void 0?Math.min(m,n):n,le=Number(e.diaVencimiento)||new Date().getDate(),de=e.fechaInicio instanceof Date?e.fechaInicio:this.toMonthDate(e.fechaInicio),ce=this.toMonthString(de),ue=this.data.prestamo?.fechaCreacion||p(new Date,"yyyy-MM-dd"),pe=p(new Date,"yyyy-MM-dd"),M={id:this.data.prestamo?.id||this.generateId(),descripcion:e.descripcion,entidad:e.entidad,tipo:e.tipo,monto:r,cuotaMensual:this.cuotaMensual,tasaInteres:o,duracionMeses:n,cuotasRestantes:f,cuotas:n,fechaInicio:ce,diaVencimiento:le,estado:e.estado,fechaCreacion:ue,fechaActualizacion:pe};try{this.data.prestamo&&this.mode==="edit"?this.appStateService.updateLoan(M):this.appStateService.addLoan(M),this.loading=!1,this.dialogRef.close(!0)}catch(fe){console.error("Error al guardar el pr\xE9stamo:",fe),this.loading=!1}}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}formatCurrency(e){return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:2}).format(e)}static \u0275fac=function(r){return new(r||d)(h($),h(ie),h(ae),h(E),h(me))};static \u0275cmp=y({type:d,selectors:[["app-prestamo-dialog"]],decls:93,vars:10,consts:[["fechaInicioPicker",""],[1,"unified-modal"],[1,"modal-header"],[1,"header-content"],[1,"header-icon"],[1,"header-title"],["mat-icon-button","","mat-dialog-close","",1,"close-button"],[1,"modal-content"],[3,"keydown.enter","formGroup"],[1,"form-section"],[1,"form-row"],[1,"full-width"],["matInput","","formControlName","descripcion","required",""],[1,"half-width"],["matInput","","formControlName","entidad","required",""],["formControlName","tipo","required",""],[3,"value",4,"ngFor","ngForOf"],["matInput","","type","number","formControlName","monto","required","","min","1"],["matTextPrefix",""],["matInput","","type","number","formControlName","tasaInteres","required","","min","0"],["matTextSuffix",""],["matInput","","type","number","formControlName","cuotas","required","","min","1"],["matInput","","readonly","",3,"value"],["matInput","","formControlName","fechaInicio","required","",3,"click","matDatepicker"],["matSuffix","",3,"for"],["formControlName","diaVencimiento","required",""],[1,"modal-actions"],["mat-stroked-button","","mat-dialog-close",""],["mat-raised-button","","color","primary",3,"click","disabled"],["diameter","20",4,"ngIf"],[4,"ngIf"],[3,"value"],["diameter","20"]],template:function(r,o){if(r&1){let n=F();t(0,"div",1)(1,"div",2)(2,"div",3)(3,"mat-icon",4),a(4,"account_balance"),i(),t(5,"h2",5),a(6),i()(),t(7,"button",6)(8,"mat-icon"),a(9,"close"),i()()(),t(10,"div",7)(11,"form",8),D("keydown.enter",function(){return g(n),S(o.onSave())}),t(12,"div",9)(13,"h3"),a(14,"Informaci\xF3n B\xE1sica"),i(),t(15,"div",10)(16,"mat-form-field",11)(17,"mat-label"),a(18,"Descripci\xF3n"),i(),u(19,"input",12),t(20,"mat-error"),a(21,"Requerido."),i()()(),t(22,"div",10)(23,"mat-form-field",13)(24,"mat-label"),a(25,"Entidad"),i(),u(26,"input",14),t(27,"mat-error"),a(28,"Requerido."),i()(),t(29,"mat-form-field",13)(30,"mat-label"),a(31,"Tipo"),i(),t(32,"mat-select",15),b(33,he,2,2,"mat-option",16),i(),t(34,"mat-error"),a(35,"Requerido."),i()()()(),t(36,"div",9)(37,"h3"),a(38,"Detalles Financieros"),i(),t(39,"div",10)(40,"mat-form-field",13)(41,"mat-label"),a(42,"Monto"),i(),u(43,"input",17),t(44,"span",18),a(45,"$\xA0"),i(),t(46,"mat-error"),a(47,"Requerido y debe ser mayor a 0."),i()(),t(48,"mat-form-field",13)(49,"mat-label"),a(50,"Tasa de Inter\xE9s Anual"),i(),u(51,"input",19),t(52,"span",20),a(53,"%"),i(),t(54,"mat-error"),a(55,"Requerido."),i()()(),t(56,"div",10)(57,"mat-form-field",13)(58,"mat-label"),a(59,"Cuotas"),i(),u(60,"input",21),t(61,"mat-error"),a(62,"Requerido."),i()(),t(63,"mat-form-field",13)(64,"mat-label"),a(65,"Cuota Mensual (calculada)"),i(),u(66,"input",22),i()()(),t(67,"div",9)(68,"h3"),a(69,"Temporalidad"),i(),t(70,"div",10)(71,"mat-form-field",13)(72,"mat-label"),a(73,"Fecha de Inicio"),i(),t(74,"input",23),D("click",function(){g(n);let f=I(77);return S(f.open())}),i(),u(75,"mat-datepicker-toggle",24)(76,"mat-datepicker",null,0),t(78,"mat-error"),a(79,"Requerido."),i()(),t(80,"mat-form-field",13)(81,"mat-label"),a(82,"D\xEDa de Vencimiento"),i(),t(83,"mat-select",25),b(84,ve,2,2,"mat-option",16),i(),t(85,"mat-error"),a(86,"Requerido."),i()()()()()(),t(87,"div",26)(88,"button",27),a(89,"Cancelar"),i(),t(90,"button",28),D("click",function(){return g(n),S(o.onSave())}),b(91,ge,1,0,"mat-spinner",29)(92,Se,2,1,"span",30),i()()()}if(r&2){let n=I(77);l(6),v(o.mode==="edit"?"Editar Pr\xE9stamo":o.mode==="duplicate"?"Duplicar Pr\xE9stamo":"Nuevo Pr\xE9stamo"),l(5),c("formGroup",o.prestamoForm),l(22),c("ngForOf",o.tiposPrestamo),l(33),c("value",o.formatCurrency(o.cuotaMensual)),l(8),c("matDatepicker",n),l(),c("for",n),l(9),c("ngForOf",o.diasVencimiento),l(6),c("disabled",o.prestamoForm.invalid||o.loading),l(),c("ngIf",o.loading),l(),c("ngIf",!o.loading)}},dependencies:[x,_,P,j,q,w,A,N,V,O,T,R,k,G,ne,z,B,L,Y,U,H,J,K,Q,X,W,Z,ee,te,oe,re],encapsulation:2})};export{se as a};
